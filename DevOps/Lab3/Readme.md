# Отчёт по лабораторной работе DevOps3

## Техническое задание
1. Написать “плохой” CI/CD файл, который работает, но в нем есть не менее пяти “bad practices” по написанию CI/CD;
2. Написать “хороший” CI/CD, в котором эти плохие практики исправлены;
3. В Readme описать каждую из плохих практик в плохом файле, почему она плохая и как в хорошем она была исправлена, как исправление повлияло на результат.

![помогите](https://github.com/paltovkletku/babaiki_devops_clouds/blob/main/DevOps/Lab3/images/%D0%BA%D0%BE%D1%82%D0%B8%D0%BA.jpg)

## CI/CD - что это?..



Как мы поняли, ci/cd (Continuous Integration-Continuous Delivery) - методология постоянной интеграции и развертывания кода. Изменения в код вносятся малыми порциями и часто, чтобы выявлять проблемы было легче.  Такая практика реализует подход автоматической сборки и упаковки приложений, их тестирования, а также автоматического развертывания.

## Плохой ci/cd

```
name: Bad CI/CD

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install deps
        run: npm install

      - name: Test
        run: npm run test
      - name: Build
        run: npm run build

      - name: Deploy
        run: |
           rsync -avz --delete ./dist/ user@server_ip:/var/www/html/
```

Bad practices:
1. Использование ubuntu:latest. latest подразумевает использование последнего доступного образа ubuntu, то есть он может меняться со временем, что может вызвать проблемы с совместимостью и прочим.
2. Отсутствует обработка ошибок. Команды run не обрабатывают ошибки, и если одна из команд не будет выполнена успешно, конвейер продолжит выполняться без остановки. Есть вероятность, что deploy начнет выполняться несмотря на то, что build не будет завершен, запустив в продакшн неисправный код.
3. Отсутствие кеширования. Без кэширования при каждом запуске все зависимости устанавливаются с нуля. Это может привести к замедлению времени сборки, увеличению затрат.
4. Использование npm install. Может быть плохой практикой в написании CI/CD, так как npm install может обновлять зависимости в package-lock.json, если в package.json указаны более новые версии. Это может привести к тому, что разные сборки будут использовать разные версии зависимостей, что усложняет отладку и может вызвать неожиданные ошибки + npm install может не всегда корректно использовать кэш, особенно если версии зависимостей изменяются.
5. Build, test и deploy объединены. Объединяя сборку, тестирование и развертывание, мы тесно связываем отдельные проблемы. Это затрудняет поддержку, обновление или отладку отдельных шагов без влияния на весь процесс. Наличие отдельных заданий для сборки и развертывания обеспечивает большую гибкость.
6. Небезопасное хранение server_ip, username, deployment_path. Пароль хранится в открытом виде в коде, что делает его доступным для всех, кто имеет доступ. Это может привести к компрометации безопасности сервера и данных.

## Хороший ci/cd
```
name: Good CI/CD

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-20.04
    steps: 
      - name: Checkout
        uses: actions/checkout@v3

      - name: Cache dependencies
        uses: actions/cache@v3
        id: cache-id
        with:
          cache: npm-dependencies
          path: ~/.npm
          key: ${{ runner.OS }}-npm-cache-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        if: steps.cache-id.outputs.cache-hit != 'true'
        run: npm ci

      - name: Build
        run: npm run build

  test:
    runs-on: ubuntu-20.04
    needs: build
    steps:
      - name: Run tests
          run: npm run test

  deploy:
    runs-on: ubuntu-20.04
    needs: test
    steps:
      - name: Deploy
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          USERNAME: ${{ secrets.USERNAME }}
          DEPLOYMENT_PATH: ${{ secrets.DEPLOYMENT_PATH }}
        run: |
          rsync -avz --delete ./dist/ $USERNAME@$SERVER_IP:$DEPLOYMENT_PATH
```

Изменения:
1. Разделение build, test и deploy. Разделив сборку, тестирование и развертывание на отдельные задания, мы обеспечиваем более надежный, гибкий и масштабируемый конвейер CI/CD. 
2. Теперь будет всегда использоваться Ubuntu 20.04 - определенная версия образа ubuntu, которая не изменится без нашего ведома.
3. Добавлена обработка ошибок сборки и тестирования. Теперь тестирование не может начаться без успешного завершения работы "build", а деплой не может начаться без успешного тестирования, то есть неисправшный код не будет запущен в продакшн.
4. Добавление кэширования. Мы добавили кэширование зависимостей. Если зависимости уже закешированы в директории ~/.npm, они будут восстановлены, и шаг завершится. Если кэша нет, зависимости установятся с помощью npm и произойдет кэширование установленных зависимостей..
5. Определение переменных окружения и использование секретов для хранения путей каталогов и ip сервера. Мы используем три переменные окружения: SERVER_IP (хранит ip-адрес сервера), USERNAME (хранит имя пользователя, используемого для доступа к серверу), DEPLOYMENT_PATH (хранит путь к директории на сервере). Значения этих переменных окружения берутся из секретов. Секреты - это защищенные значения, которые не отображаются в логах и не доступны для чтения в открытом виде. Использование переменных окружения и секретов обеспечивает безопасность и гибкость.
6. Вместо npm install используем npm ci (clean install). Чистая установка работает быстрее и гарантирует, что зависимости будут установлены в точности так, как прописано в package-lock.json.
## Наши мысли после лабы и истории про Васю

![оно того стоит?](https://github.com/paltovkletku/babaiki_devops_clouds/blob/main/DevOps/Lab3/images/%D0%B1%D0%BE%D0%B1%D0%B0%D0%BA%D0%B0.jpg)

![хабр](https://github.com/paltovkletku/babaiki_devops_clouds/blob/main/DevOps/Lab3/images/%D1%85%D0%B0%D0%B1%D1%80.jpg)

![лабы](https://github.com/paltovkletku/babaiki_devops_clouds/blob/main/DevOps/Lab3/images/%D0%BB%D0%B0%D0%B1%D1%8B.jpg)

![шутка](https://github.com/paltovkletku/babaiki_devops_clouds/blob/main/DevOps/Lab3/images/%D1%88%D1%83%D1%82%D0%BA%D0%B0.jpg)





Выполнили: Борисевич Анна, Ходакова Мария.

